# Copyright 2025 Xenon Emulator Project

set(BUILD_SHARED_LIBS OFF)
set(BUILD_TESTING OFF)
set_directory_properties(PROPERTIES EXCLUDE_FROM_ALL ON SYSTEM ON)

# Set CMP0069 policy to "NEW" for building external targets with LTO enabled
set(CMAKE_POLICY_DEFAULT_CMP0069 NEW)

# fmt
if (NOT TARGET fmt::fmt)
  add_subdirectory(fmt)
endif()

# GLAD
add_subdirectory(glad)

# SDL3
if (GFX_ENABLED)
  if (NOT TARGET SDL3::SDL3)
    set(SDL_DISKAUDIO OFF)
    set(SDL_TEST_LIBRARY OFF)
    set(SDL_PIPEWIRE OFF)
    add_subdirectory(SDL3)
  endif()
endif()

# Sirit
if (NOT TARGET sirit)
  # Override compiler flags based on proper defines
  if (CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
      set(SIRIT_CXX_FLAGS
          /std:c++latest # CMAKE_CXX_STANDARD as no effect on MSVC until CMake 3.10.
          /W4
          /w34263 # Non-virtual member function hides base class virtual function
          /w44265 # Class has virtual functions, but destructor is not virtual
          /w34456 # Declaration of 'var' hides previous local declaration
          /w34457 # Declaration of 'var' hides function parameter
          /w34458 # Declaration of 'var' hides class member
          /w34459 # Declaration of 'var' hides global definition
          /w34946 # Reinterpret-cast between related types
          /wd4592 # Symbol will be dynamically initialized (implementation limitation)
          /permissive- # Stricter C++ standards conformance
          /MP
          /Zi
          /Zo
          /EHsc
          /Zc:inline # Omits inline functions from object-file output
          /DNOMINMAX
          /WX)

      if (CMAKE_VS_PLATFORM_TOOLSET MATCHES "LLVM-vs[0-9]+")
          list(APPEND SIRIT_CXX_FLAGS
              -Qunused-arguments
              -Wno-missing-braces)
      endif()
  else()
      set(SIRIT_CXX_FLAGS
          -Wall
          -Wextra
          -Wcast-qual
          -pedantic
          -pedantic-errors
          -Wfatal-errors
          -Wno-missing-braces
          -Wconversion
          -Wsign-conversion
          -Wshadow
          -Werror)
  endif()
  add_subdirectory(Sirit)
endif()

# Toml11
if (NOT TARGET toml11::toml11)
  add_subdirectory(toml11)
  set(TOML11_INSTALL OFF)

  # This removes the warnings generated by toml11
  if (CMAKE_CXX_COMPILER_ID STREQUAL "Clang" AND CMAKE_CXX_COMPILER_FRONTEND_VARIANT STREQUAL "MSVC")
    get_target_property(_toml11_compile_options toml11 INTERFACE_COMPILE_OPTIONS)
    list(REMOVE_ITEM _toml11_compile_options "/Zc:preprocessor")
    set_target_properties(toml11 PROPERTIES INTERFACE_COMPILE_OPTIONS ${_toml11_compile_options})
  endif()
endif()
